var map,mapiniciado=!1,markers=[];function initMap(e,a,t){mapeostitulo={},0==mapiniciado?(map=L.map("map").setView([e,a],t),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{scrollWheelZoom:!1}).addTo(map),L.control.search({url:urlval+"/endpoint/get_places?q={s}",textPlaceholder:"Buscar",position:"topleft",marker:!1,formatData:function(e){var a={};for(var t in mapeostitulo={},e)a[e[t].title]=L.latLng(e[t].loc),mapeostitulo[e[t].title]=e[t].id;return a},moveToLocation:function(e,a,t){t.setView(e,nivelzoommapabusqueda,{animate:!1}),addMarker({latlng:e})}}).addTo(map),map.on("click",addMarker),map.on("focus",function(){map.scrollWheelZoom.enable()}),map.on("blur",function(){map.scrollWheelZoom.disable()}),mapiniciado=!0):map.setView([e,a],t)}function clearMarkers(){void 0!==markers[0]&&map.removeLayer(markers[0])}function addMarker(e){deleteMarkers();var a=L.icon({iconUrl:"/uploads/ico_circle_75x75.png",iconSize:[77,77],iconAnchor:[38,38]}),t=new L.marker(e.latlng,{icon:a}).addTo(map);markers.push(t)}function deleteMarkers(){clearMarkers(),markers=[]}function formatRepo(e){return e.loading,e.text}function formatRepoSelection(e){return e.full_name||e.text}nivelzoommapa=6,nivelzoommapabusqueda=15,$(document).ready(function(){anguloactual=0,$("body").on("click","button.rotate",function(){degrees=parseInt(anguloactual+90),degrees>360&&(degrees=90),anguloactual=degrees,$("#imagenlugar").css({"-webkit-transform":"rotate("+degrees+"deg)","-moz-transform":"rotate("+degrees+"deg)","-ms-transform":"rotate("+degrees+"deg)","-o-transform":"rotate("+degrees+"deg)",transform:"rotate("+degrees+"deg)",zoom:1})}),"undefined"==typeof loadcampos&&(componercampos(),$("input[maxlength]").maxlength()),0==dataConfig.length&&$("label.labelcamposdin").hide()}),"undefined"==typeof nombreshortproyect&&(pybossa.taskLoaded(function(e,a){$.isEmptyObject(e),a.resolve(e)}),pybossa.presentTask(function(e,a){if($.isEmptyObject(e))pybossaNotify("Ya ha contribuido en todas las tareas del proyecto, muchas gracias por su colaboración.","info",!0),$("#contenedortarea").hide(),$("#finalizado").show();else{if(cargarenlaceurl(e),obtenersiguientetarea(e.project_id,e.id),loadUserProgress(),void 0!==e.info.resource)var t=e.info.resource;else t="http://bdh-rd.bne.es/pdf.raw?query=id:"+e.info.id+"&jpeg=true&page="+e.info.page;$("#imagenlugar").attr("src",t),$("#imagenlugar").attr("data-zoom-image",t);var o=$("#documentopdf");o.find(".panzoom").panzoom({$zoomIn:o.find(".mas"),$zoomOut:o.find(".menos"),$zoomRange:o.find(".zoom-range"),$reset:o.find(".reset"),increment:.1,minScale:1}),"si"==mapa?initMap(40.43022363450862,-3.6914062500000004,nivelzoommapa):($("#map").hide(),$("#direccion").hide()),$("#guardar").off("click").on("click",function(){var t={},o=!1;if($.each(dataConfig,function(e,a){var i=a.tipo,r=a.id;switch(i){case"selectsimpleauto":t[r+"id"]=$("#"+r).val(),""!=t[r+"id"]&&null!=t[r+"id"]?(t[r+"txt"]=$("#"+r).select2("data")[0].text,o=!0):(t[r+"id"]="",t[r+"txt"]="");break;case"selectsimplemanual":t[r+"id"]=$("#"+r).val(),null==t[r+"id"]?t[r+"id"]="":o=!0;break;case"selectmultipleauto":void 0===t[r]&&(t[r]=[]),$($("#"+r).select2("data")).each(function(e,a){o=!0,t[r].push({id:a.id,text:a.text})});break;case"text":case"number":t[r]=$("#"+r).val(),""!=t[r]&&(o=!0);break;case"selectsimpleagrupado":void 0===t[r]&&(t[r]=[]);var n=a.select1.id,l=a.select2.id;if(void 0!==a.select3)var s=a.select3.id;else s="nodefinido";$("."+r).each(function(e,a){t[r].push({["id"+n]:$(a).attr("dat"+n+"id"),["text"+n]:$(a).attr("dat"+n+"txt"),["id"+l]:$(a).attr("dat"+l+"id"),["text"+l]:$(a).attr("dat"+l+"txt"),["id"+s]:$(a).attr("dat"+s+"id"),["text"+s]:$(a).attr("dat"+s+"txt")}),o=!0})}}),1==o||void 0!==markers[0]){t.dataConfig=JSON.stringify(dataConfig),t.mapa=mapa,void 0!==markers[0]?(t.lat=markers[0].getLatLng().lat,t.lng=markers[0].getLatLng().lng):(t.lat=0,t.lng=0),t.id=e.info.id,t.page=e.info.page,void 0!==e.info.resource&&(t.resource=e.info.resource),t.comentario=$("#comentario").val(),t.infoadicional=$("#infoadi").val();var i=[];$(".datoenlacefuente").each(function(e,a){""!=$(a).text()&&i.push({url:$(a).text()})}),t.enlacesfuentesdatos=i;var r=JSON.stringify(t);pybossa.saveTask(e.id,r).done(function(e){deleteMarkers(),$("#comentario").val(""),$("#comentario").hide(),$("#direccion").val(""),$("#infoadi").val(""),$(".datoenlacefuente").remove(),$(".eliminardatoenlacefuente").remove(),$.each(dataConfig,function(e,a){var t=a.tipo,o=a.id;if("selectsimpleauto"==t||"selectsimplemanual"==t||"selectmultipleauto"==t)$("#"+o).val(null).trigger("change");else if("text"==t||"number"==t)$("#"+o).val("");else if("selectsimpleagrupado"==t){$("."+o).remove();var i=a.select1,r=a.select2,n=a.select3;$("#"+i.id).val(null).trigger("change"),$("#"+r.id).val(null).trigger("change"),void 0!==n&&$("#"+n.id).val(null).trigger("change")}}),pybossaNotify("Gracias por su contribución.","success",!0),$("html, body").animate({scrollTop:$(".container-fluid").offset().top},2e3),a.resolve()})}else pybossaNotify("Es obligatorio completar la siguiente información.","error",!0)})}}));