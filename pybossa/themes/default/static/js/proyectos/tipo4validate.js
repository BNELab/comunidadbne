function refrescaranotacionestexto(){if("undefined"!=typeof currentannotation&&""!=currentannotation)var e=currentannotation;var a="";if(void 0!==e&&void 0!==e.datos){var t=e.datos;if(void 0!==t.personas&&(a+="<div><span class='ntipo'>Personas:</span>",$(t.personas).each(function(e,t){var o=t.text;a+="<p> "+o+"</p>"}),a+="</div>"),void 0!==t.entidades&&(a+="<div><span class='ntipo'>Entidades:</span>",$(t.entidades).each(function(e,t){var o=t.text;a+="<p> "+o+"</p>"}),a+="</div>"),void 0===t.titulos&&void 0===t.autores||(void 0!==t.titulos&&t.titulos.length>0&&(a+="<div><span class='ntipo'>Títulos:</span>",$(t.titulos).each(function(e,t){var o=t.text;a+="<p> "+o+"</p>"}),a+="</div>"),void 0!==t.autores&&t.autores.length>0&&(a+="<div><span class='ntipo'>Autores:</span>",$(t.autores).each(function(e,t){var o=t.text;a+="<p> "+o+"</p>"}),a+="</div>")),void 0!==t.lugares&&(a+="<div><span class='ntipo'>Lugar:</span>",$(t.lugares).each(function(e,t){var o=t.text;a+="<p> "+o+"</p>"}),a+="</div>"),void 0!==t.etiquetadosocial&&(a+="<div><span class='ntipo'>Etiquetas temáticas:</span>",$(t.etiquetadosocial).each(function(e,t){var o=t.id;a+="<p> "+o+"</p>"}),a+="</div>"),void 0!==t.textoasociado){a+="<div><span class='ntipo'>Texto asociado:</span>";var o=t.textoasociado;a+="<p> "+o+"</p>",a+="</div>"}}$("#listaetiquetastexto").html(a)}function refrescaranotaciones(){$("#listanotaciones").html("");var e=anno.getAnnotations();$(e).each(function(e,a){var t="";1==a.valida&&(t="checked"),$("#listanotaciones").prepend('<li class="datoanotacion '+t+'" data="'+e+'"> '+a.texto+'  <div class="delaedit"></div> <input type="checkbox" class="valido" '+t+"></li>")})}function formatRepo(e){return e.loading,e.text}function formatRepoSelection(e){return e.full_name||e.text}function cargardatosetiquetado(){$.ajax({url:urlval+"endpoint/get_etiquetasocial?p="+proyectid,data:{}}).done(function(e){if(""!=e){var a=jQuery.parseJSON(e),t="";$.each(a.items,function(e,a){t+="<option value='"+a.id+"'>"+a.text+"</option>"}),$(".js-data-ajax-etiquetasocial").append(t)}var o=$(".js-data-ajax-etiquetasocial").attr("placeholder");$(".js-data-ajax-etiquetasocial").select2({language:"es",theme:"bootstrap",placeholder:o,tags:!0,minimumInputLength:3}),$(".js-data-ajax-etiquetasocial").val("").trigger("change")})}function limpiarfront(){$("#selectordetipoetiqueta").val(""),$("#persona").val("").trigger("change"),$("#entidad").val("").trigger("change"),$("#titulo").val("").trigger("change"),$("#autor").val("").trigger("change"),$("#textoasociadoarea").val(""),$("#nombredellugar").val("").trigger("change"),$("#direccion").val(""),$("#etiquetassociales").val("").trigger("change")}function cargarAnotacion(e){if(limpiarfront(),void 0!==e.datos){var a=e.datos;if(void 0!==a.personas){var t=[];$(a.personas).each(function(e,a){if($("#persona").find("option[value='"+a.id+"']").length)t.push(a.id);else{var o=new Option(a.text,a.id,!0,!0);$("#persona").append(o).trigger("change")}}),t.length>0&&$("#persona").val(t).trigger("change")}if(void 0!==a.entidades){t=[];$(a.entidades).each(function(e,a){if($("#entidad").find("option[value='"+a.id+"']").length)t.push(a.id);else{var o=new Option(a.text,a.id,!0,!0);$("#entidad").append(o).trigger("change")}}),t.length>0&&$("#entidad").val(t).trigger("change")}if(void 0!==a.titulos||void 0!==a.autores){t=[];$(a.titulos).each(function(e,a){if($("#titulo").find("option[value='"+a.id+"']").length)t.push(a.id);else{var o=new Option(a.text,a.id,!0,!0);$("#titulo").append(o).trigger("change")}}),t.length>0&&$("#titulo").val(t).trigger("change");t=[];$(a.autores).each(function(e,a){if($("#autor").find("option[value='"+a.id+"']").length)t.push(a.id);else{var o=new Option(a.text,a.id,!0,!0);$("#autor").append(o).trigger("change")}}),t.length>0&&$("#autor").val(t).trigger("change")}if(void 0!==a.lugares){t=[];var o=0,i=0;$(a.lugares).each(function(e,a){if($("#nombredellugar").find("option[value='"+a.id+"']").length)t.push(a.id);else{var n=new Option(a.text,a.id,!0,!0);$("#nombredellugar").append(n).trigger("change")}o=a.lat,i=a.lng}),t.length>0&&$("#nombredellugar").val(t).trigger("change"),deleteMarkers();var n={lat:o,lng:i};addMarker(n),centerMap(n)}if(void 0!==a.etiquetadosocial){t=[];$(a.etiquetadosocial).each(function(e,a){if($("#etiquetassociales").find("option[value='"+a.id+"']").length)t.push(a.id);else{var o=new Option(a.id,a.id,!0,!0);$("#etiquetassociales").append(o).trigger("change")}}),t.length>0&&$("#etiquetassociales").val(t).trigger("change")}void 0!==a.textoasociado&&$("#textoasociadoarea").val(a.textoasociado)}}function componercampoagrupado(e){var a="",t=e.tipo,o=e.id,i=e.titulo,n=e.codigoautocompletado,l=e.valores;switch(a=(a=htmltiposcampo[t]).replace("##ID##",o),t){case"selectsimpleauto":a=(a=a.replace("##CODIGOAUTOCOMPLETADO##",n)).replace("##TITULO##",i);break;case"selectsimplemanual":var r="";$.each(l,function(e,a){var t=option;t=(t=t.replace("##ID##",a)).replace("##TEXTO##",a),r+=t}),a=(a=a.replace("##TITULO##",i)).replace("##VALORES##",r);break;case"selectmultipleauto":a=(a=a.replace("##CODIGOAUTOCOMPLETADO##",n)).replace("##TITULO##",i);break;default:a=""}return a}function eventoscampos(){$(".comon-single").each(function(e){var a=$(this).attr("placeholder");$(this).select2({language:"es",theme:"bootstrap",placeholder:a,tags:!0}),$(this).val("").trigger("change")}),$(".js-data-ajax").each(function(){var e=$(this).attr("placeholder"),a=$(this).attr("tipe");$(this).select2({theme:"bootstrap",tags:!0,placeholder:e,language:"es",ajax:{url:urlval+"endpoint/get_databne?type="+a,dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e,a){return{results:e.items}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:formatRepo,templateSelection:formatRepoSelection}),$(this).val("").trigger("change")})}function componercampos(){var e="";$.each(dataConfig,function(a,t){var o="",i=t.id,n=t.titulo,l=t.tipo,r=t.codigoautocompletado,s=t.valores;switch(o=(o=htmltiposcampo[l]).replace("##ID##",i),l){case"selectsimpleauto":o=(o=o.replace("##CODIGOAUTOCOMPLETADO##",r)).replace("##TITULO##",n);break;case"selectsimplemanual":var c="";$.each(s,function(e,a){var t=option;t=(t=t.replace("##ID##",a)).replace("##TEXTO##",a),c+=t}),o=(o=o.replace("##TITULO##",n)).replace("##VALORES##",c);break;case"selectmultipleauto":o=(o=o.replace("##CODIGOAUTOCOMPLETADO##",r)).replace("##TITULO##",n);break;case"text":if(o=o.replace("##TITULO##",n),""!=t.limitecaracteres&&0!=t.limitecaracteres)var d=' maxlength="'+t.limitecaracteres+'"';else d="";o=o.replace("##LIMITECARACTERES##",d);break;case"number":o=o.replace("##TITULO##",n);break;case"selectsimpleagrupado":var p,u=t.select1,g=t.select2,m=t.select3;p=componercampoagrupado(u),select2=componercampoagrupado(g),o=(o=(o=o.replace("##ID##",i)).replace("##SELECT1##",p)).replace("##SELECT2##",select2),void 0!==m?(select3=componercampoagrupado(m),o=(o=(o=(o=(o=o.replace("##SELECT3##",select3)).replace("##A1##",25)).replace("##A2##",25)).replace("##A3##",25)).replace("##A4##",25)):o=(o=(o=(o=(o=o.replace("##SELECT3##","")).replace("##A1##",50)).replace("##A2##",25)).replace("##A3##",0)).replace("##A4##",25);break;default:o=""}e+=espaciado+o}),$("#campos").html(e),$(".comon-single").each(function(e){var a=$(this).attr("placeholder");$(this).select2({language:"es",theme:"bootstrap",placeholder:a,tags:!0}),$(this).val("").trigger("change")}),$(".js-data-ajax").each(function(){var e=$(this).attr("placeholder"),a=$(this).attr("tipe");$(this).select2({theme:"bootstrap",tags:!0,placeholder:e,language:"es",ajax:{url:urlval+"endpoint/get_databne?type="+a,dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e,a){return{results:e.items}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:3,templateResult:formatRepo,templateSelection:formatRepoSelection}),$(this).val("").trigger("change")}),$.each(dataConfig,function(e,a){var t=a.tipo,o=a.id;if("selectsimpleagrupado"==t){var i=$("#add"+o),n=$("#"+o),l=a.select1.id,r=a.select2.id;if(void 0!==a.select3)var s=a.select3.id;else s="nodefinido";i.on("click",function(e){e.preventDefault();var t=$("#"+l).select2("data");""!=$("#"+l).val()&&null!=$("#"+l).val()?(idinputValuepers=t[0].id,inputValuepers=t[0].text):(idinputValuepers="",inputValuepers="");var i=$("#"+r).select2("data");if(""!=$("#"+r).val()&&null!=$("#"+r).val()?(idinputValuerol=i[0].id,inputValuerol=i[0].text):(idinputValuerol="",inputValuerol=""),void 0!==a.select3){var c=$("#"+s).select2("data");""!=$("#"+s).val()&&null!=$("#"+s).val()?(idinputValuerol3=c[0].id,inputValuerol3=c[0].text,continuarselect3=!0):(idinputValuerol3="",inputValuerol3="",continuarselect3=!1)}else continuarselect3=!0,idinputValuerol3="",inputValuerol3="";if(""!=inputValuerol&&""!=inputValuepers&&1==continuarselect3){var d=inputValuepers+": "+inputValuerol;void 0!==a.select3&&(d+=": "+inputValuerol3),n.prepend('<li class="'+o+'" dat'+l+'id="'+idinputValuepers+'" dat'+l+'txt="'+inputValuepers+'" dat'+r+'id="'+idinputValuerol+'" dat'+r+'txt="'+inputValuerol+'" dat'+s+'id="'+idinputValuerol3+'" dat'+s+'txt="'+inputValuerol3+'"> '+d+'   <i class="icono-eliminador icon fa fa-close del'+o+'"></i></li>'),$("#"+a.select1.id).val(null).trigger("change"),$("#"+a.select2.id).val(null).trigger("change"),void 0!==a.select3&&$("#"+a.select3.id).val(null).trigger("change")}else pybossaNotify("Debes introducir datos antes de añadir.","error",!0)}),$("body").on("click","i.del"+o,function(){$(this).parent().remove()})}})}var map;anno.addPlugin("FancyBoxSelector",{activate:!0}),$("body").on("change",".datoanotacion .valido",function(){var e=$(this).parent().attr("data");if($(this).is(":checked"))var a=!0;else a=!1;var t=anno.getAnnotations();$(t).each(function(t,o){t==e&&(o.valida=a)})}),htmltiposcampo=[],htmltiposcampo.selectsimpleauto='<select id="##ID##" name="element" class="form-control js-data-ajax js-data-example-ajax" tipe="##CODIGOAUTOCOMPLETADO##" placeholder="##TITULO##"><option value=""></option></select>',htmltiposcampo.selectsimplemanual='<select id="##ID##" name="element" class="form-control comon-single" placeholder="##TITULO##">##VALORES##</select>',htmltiposcampo.selectmultipleauto='<select id="##ID##" name="element" class="form-control js-data-ajax js-data-example-ajax" tipe="##CODIGOAUTOCOMPLETADO##" multiple placeholder="##TITULO##"></select>',htmltiposcampo.text='<input class="form-control" id="##ID##" placeholder="##TITULO##" type="text" value="" ##LIMITECARACTERES##>',htmltiposcampo.number='<input class="form-control" id="##ID##" placeholder="##TITULO##" type="number" value="">',htmltiposcampo.selectsimpleagrupado='<div class="form-group"><div class="input-group"><div class="input-group-btn" style="width: ##A1##% !important;padding-right: 10px;">##SELECT1##</div><div class="input-group-btn" style="width: ##A2##% !important;padding-right: 10px;">##SELECT2##</div><div class="input-group-btn" style="width: ##A3##% !important;">##SELECT3##</div><div style="width: ##A4##% !important"><button class="btn btn-default margin-top-xs" id="add##ID##" type="button" style="margin-top: 0px;margin-left: 10px;"> <i class="fa fa-plus" aria-hidden="true"></i></button></div></div></div><div class="row"><ul id="##ID##" class="listaselectagrupado"></ul></div>',option='<option value="##ID##">##TEXTO##</option>',espaciado="<span><small>&nbsp;</small></span>",$(document).ready(function(){$("body").on("mouseover","#listanotaciones li",function(){var e=anno.getAnnotations(),a=$(this).attr("data");anno.showSelectionWidget(e[a]),anno.highlightAnnotation(e[a])}),$("body").on("click","div.dela",function(){$(this).parent().remove();var e=$(this).parent().attr("data");anno.removeAnnotation(anno.getAnnotations()[e]),refrescaranotaciones()}),$("body").on("click","div.delaedit",function(){var e=$(this).parent().attr("data");objetoanotator.editAnnotation(anno.getAnnotations()[e])}),"undefined"==typeof loadcampos?(componercampos(),$("input[maxlength]").maxlength()):eventoscampos(),cargardatosetiquetado(),$("body").on("click",".guardardata",function(){var e=$(this).attr("tipo");if(void 0!==currentannotation.datos){var a=currentannotation.datos;editardatosmodal=1}else{a={};editardatosmodal=0}var t=0,o="",i="";switch(e){case"personas":a.personas=[],$($("#persona").select2("data")).each(function(e,t){a.personas.push({id:t.id,text:t.text}),i=t.text}),void 0===$($("#persona").select2("data"))[0]&&(t=1,o="Es obligatorio añadir al menos una persona.");break;case"entidades":a.entidades=[],$($("#entidad").select2("data")).each(function(e,t){a.entidades.push({id:t.id,text:t.text}),i=t.text}),void 0===$($("#entidad").select2("data"))[0]&&(t=1,o="Es obligatorio añadir al menos una entidad.");break;case"obras":var n="",l="";a.titulos=[],$($("#titulo").select2("data")).each(function(e,t){a.titulos.push({id:t.id,text:t.text}),n=t.text}),a.autores=[],$($("#autor").select2("data")).each(function(e,t){a.autores.push({id:t.id,text:t.text}),l=t.text}),void 0===$($("#titulo").select2("data"))[0]&&void 0===$($("#autor").select2("data"))[0]&&(t=1,o="Es obligatorio añadir al menos un título o autor."),i=n+" "+l;break;case"lugares":if("null"==typeof $("#nombredellugar").val()||""==$("#nombredellugar").val())t=1,o="Es obligatorio añadir un lugar.";else{var r=$("#nombredellugar").select2("data")[0].id,s=$("#nombredellugar").select2("data")[0].text;i=s,a.lugares=[],a.lugares.push({id:r,text:s}),deleteMarkers()}break;case"etiquetadosocial":a.etiquetadosocial=[],$($("#etiquetassociales").select2("data")).each(function(e,t){a.etiquetadosocial.push({id:t.id}),i=t.id}),void 0===$($("#etiquetassociales").select2("data"))[0]&&(t=1,o="Es obligatorio añadir al menos una etiqueta social.");break;case"textoasociado":""==$("#textoasociadoarea").val()?(t=1,o="Es obligatorio añadir un texto."):(a.textoasociado=$("#textoasociadoarea").val(),i=$("#textoasociadoarea").val())}if(0==t){var c=JSON.parse(JSON.stringify(a));$("#myModal"+e).modal("hide"),setTimeout(function(){1==editardatosmodal?(currentannotation.datos=c,currentannotation.text="",objetoanotator.fireEvent("onAnnotationUpdated",currentannotation,objetoanotator.getItem())):(currentannotation.datos=c,currentannotation.text="",currentannotation.texto=i,objetoanotator.addAnnotation(currentannotation),objetoanotator.fireEvent("onAnnotationCreated",currentannotation,objetoanotator.getItem())),$("#selectordetipoetiqueta").val("")},500)}else pybossaNotify(o,"error",!0)})});var markers=[];function initMap(e,a,t){var o={lat:e,lng:a};inputdir=document.getElementById("direccion"),map=new google.maps.Map(document.getElementById("mapa"),{zoom:t,center:o,mapTypeId:"roadmap",mapTypeControl:!1,styles:[{featureType:"administrative",elementType:"all",stylers:[{visibility:"on"},{lightness:33}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2e5d4"}]},{featureType:"poi.business",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#c5dac6"}]},{featureType:"poi.park",elementType:"labels",stylers:[{visibility:"on"},{lightness:20}]},{featureType:"poi.place_of_worship",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"road",elementType:"all",stylers:[{lightness:20}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#c5c6c6"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#e4d7c6"}]},{featureType:"road.local",elementType:"geometry",stylers:[{color:"#fbfaf7"}]},{featureType:"transit.station.bus",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"transit.station.rail",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{visibility:"on"},{color:"#acbcc9"}]}]}),iconomapa={url:"/uploads/ico_circle_75x75.png",anchor:new google.maps.Point(38,38),size:new google.maps.Size(77,77),origin:new google.maps.Point(0,0)},map.addListener("click",function(e){deleteMarkers(),addMarker(e.latLng)});var i=new google.maps.places.Autocomplete(inputdir);i.bindTo("bounds",map),i.addListener("place_changed",function(){var e=i.getPlace();e.geometry?(map.setCenter(e.geometry.location),map.setZoom(nivelzoommapabusqueda)):pybossaNotify("No se ha podido encontrar una dirección valida.","error",!0)})}function clearMarkers(){setMapOnAll(null)}function addMarker(e){}function showMarkers(){setMapOnAll(map)}function deleteMarkers(){clearMarkers(),markers=[]}function setMapOnAll(e){for(var a=0;a<markers.length;a++)markers[a].setMap(e)}function centerMap(e){}nivelzoommapa=6,nivelzoommapabusqueda=17;